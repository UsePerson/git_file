<!DOCTYPE html>
<html lang= "en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="This web is FJU CSIE web project -- chatroom project">
		<meta name="author" content="CrazyFire, DogQ, Nicky, USER">
		<meta name="generator" content="Jekyll v4.0.1">

		<title>FJUChatRoom</title>
		<!-- bootstrap css include -->
		<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<script src="https://kit.fontawesome.com/c78a8bbd32.js" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

		<!-- bootstrap JS include -->
		
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

		<style>
			.bd-placeholder-img {
				font-size: 1.125rem;
				text-anchor: middle;
				-webkit-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
	  
			@media (min-width: 768px) {
				.bd-placeholder-img-lg {
					font-size: 3.5rem;
				}
			}
		</style>
		<!-- Custom styles for this template -->
		<link href="/css/match.css" rel="stylesheet">
	</head>

	<body>
		<header>
			<div class="navbar navbar-expand-md navbar-dark fixed-top bg-dark d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 border-bottom shadow-sm">
				<nav class="navbar navbar-expand-md navbar-dark my-0 mr-md-auto font-weight-normal justify-content-between">
					<a class="navbar-brand text-white" href="/match.html">FJU ChatRoom</a>
				</nav>
				<a class="btn btn-outline-light my-2 my-md-0 mr-md-3" href="/setup.html">
					<i class="fas fa-users-cog"></i>
				</a>
				<a id="sign_out" class="btn btn-outline-danger my-2 my-md-0 mr-md-3" href="/index.html">Sign out</a>
			</div>
		</header>

		<main role="main" class="container marketing">
			<div id="myCarousel" class="carousel slide" data-ride="carousel">
				<div class="container">
					<div class="container-fluid py-5 text-center">
						<h1>Matching</h1>
						<div class="row">
							<div class="col-sm-4 card-dark">
								<div class="card">
									<div class="card-header">
										<h2>Chat History</h2>
									</div>
									<div class="card-body" id="chat-history">
										<!-- The chat history is right here -->
									</div>
								</div>
							</div>
							<div class="col-sm-8">
								<div class="card">
									<div class="card-header">
										<h2>Online List</h2>
									</div>
									<div class="card-body" id="online-list">
										<!-- The online list is right here -->
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>

		<!-- The core Firebase JS SDK is always required and must be listed first -->
		<script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
		<!-- TODO: Add SDKs for Firebase products that you want to use
			https://firebase.google.com/docs/web/setup#available-libraries -->
		<script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-analytics.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-database.js"></script>
		<script>
			// Your web app's Firebase configuration
			var firebaseConfig = {
				apiKey: "AIzaSyCAOj-dhi5ABTjcwRRuse4b8gckv9gb1cA",
				authDomain: "web-2020-9016a.firebaseapp.com",
				databaseURL: "https://web-2020-9016a.firebaseio.com",
				projectId: "web-2020-9016a",
				storageBucket: "web-2020-9016a.appspot.com",
				messagingSenderId: "235406339567",
				appId: "1:235406339567:web:d38bd8667b2b5de7659a1a",
				measurementId: "G-MF4J99D3Y9"
			};
			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			firebase.analytics();
			const database = firebase.database();

			function listenOnlineStatus(user){
				var uid = user.uid;
				console.log(uid);
				var userStatusDatabaseRef = firebase.database().ref('/status/' + uid);

				var isOfflineForDatabase = {
				    state: 'offline',
				    name: '',
				    last_changed: firebase.database.ServerValue.TIMESTAMP,
				};

				var isOnlineForDatabase = {
				    state: 'online',
				    name: '',
				    last_changed: firebase.database.ServerValue.TIMESTAMP,
				};

				firebase.database().ref('.info/connected').on('value', function(snapshot) {
				    // If we're not currently connected, don't do anything.
				    if (snapshot.val() == false) {
				        return;
				    };
				    firebase.database().ref('/user_information/'+uid).once('value', function(user){
				    	var userName = user.val().username;
				    	isOfflineForDatabase.name = userName;
				    	userStatusDatabaseRef.onDisconnect().set(isOfflineForDatabase).then(function() {
					        // https://firebase.google.com/docs/reference/js/firebase.database.OnDisconnect
					        isOnlineForDatabase.name = userName;
					        userStatusDatabaseRef.set(isOnlineForDatabase);
					    });
				    });
				});
			} 

			function updateOnlineList(){
				var userStatusDatabaseRef = firebase.database().ref('/status/');
				userStatusDatabaseRef.on('value', function (snapshot){
					var val = snapshot.val();
					let list = '';
					var onlineNumber = 0;

					$.each(val, function (uid, item){
						var state = item.state;
						if(state === "online"){
							list = `${list}<button class="list-group-item list-group-item-action">${item.name}</button>`
							onlineNumber += 1;
						}
					});
					$("#online-list").html(list);
					
					console.log("onlineNumber: " + onlineNumber);
				});

			}

			firebase.auth().onAuthStateChanged(function(user) {
				if (user) {
				  // User is signed in.
				  
				//  var name = user.name;
				//  var email = user.email;
				//  var emailVerified = user.emailVerified;
				//  var photoURL = user.photoURL;
				//  var isAnonymous = user.isAnonymous;
				//  var uid = user.uid;
				//  var providerData = user.providerData;
					
				  if( user.displayName == null ){
					 myCarousel.innerHTML ="\<meta http-equiv = \"refresh\" content = \"0; url = \/setup.html\" \/\>";
				  }
					listenOnlineStatus(user);
					updateOnlineList();
				} else {
				  // User is signed out.
				  // ...
				  sign_out.innerHTML ="\<meta http-equiv = \"refresh\" content = \"0; url = \/index.html\" \/\>";
				  
				}
			});

			sign_out.addEventListener('click', () => {
				firebase.auth().signOut().then(function() {
					// Sign-out successful.
					sign_out.innerHTML ="\<meta http-equiv = \"refresh\" content = \"0; url = \/index.html\" \/\>";
				  }).catch(function(error) {
					// An error happened.
				});
			});
		</script>
	</body>
</html>